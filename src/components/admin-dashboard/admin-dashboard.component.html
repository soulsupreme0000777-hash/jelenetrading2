<div class="flex h-screen bg-gray-100 dark:bg-gray-900 font-sans">
  <!-- Mobile Sidebar Backdrop -->
  @if(isSidebarOpen()) {
    <div (click)="isSidebarOpen.set(false)" class="fixed inset-0 bg-black/60 z-30 sm:hidden"></div>
  }

  <!-- Sidebar -->
  <div 
    class="w-64 bg-white dark:bg-gray-800 text-gray-800 dark:text-white flex flex-col border-r border-gray-200 dark:border-gray-700 fixed inset-y-0 left-0 z-40 transform transition-transform duration-300 ease-in-out sm:relative sm:translate-x-0"
    [class.-translate-x-full]="!isSidebarOpen()"
    [class.translate-x-0]="isSidebarOpen()">
    
    <!-- Sidebar Header -->
    <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
      <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Admin Panel</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">Payroll & HR Management</p>
    </div>
    
    <!-- Navigation -->
    <nav class="flex-1 px-4 py-4 space-y-1">
        <a href="#" (click)="setActiveTab('employees'); isSidebarOpen.set(false); $event.preventDefault()" class="flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200" [class.bg-indigo-600]="activeTab() === 'employees'" [class.text-white]="activeTab() === 'employees'" [class.hover:bg-gray-100]="activeTab() !== 'employees'" [class.dark:hover:bg-gray-700]="activeTab() !== 'employees'">
           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.67c.625-.934 1-2.122 1-3.417v-.175a6.375 6.375 0 015.375-6.232A12.318 12.318 0 0118.375 3.625c-2.331 0-4.512.645-6.374 1.766l-.001.109a6.375 6.375 0 01-11.964 4.67c-.625.934-1 2.122-1 3.417v.175a6.375 6.375 0 01-5.375 6.232A12.318 12.318 0 016.625 19.375c2.331 0 4.512-.645 6.374-1.766l.001.109z" /></svg>
           <span class="ml-3 font-medium">Employees</span>
        </a>
        <a href="#" (click)="setActiveTab('dtr'); isSidebarOpen.set(false); $event.preventDefault()" class="flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200" [class.bg-indigo-600]="activeTab() === 'dtr'" [class.text-white]="activeTab() === 'dtr'" [class.hover:bg-gray-100]="activeTab() !== 'dtr'" [class.dark:hover:bg-gray-700]="activeTab() !== 'dtr'">
           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
           <span class="ml-3 font-medium">DTR Logs</span>
        </a>
        <a href="#" (click)="setActiveTab('payroll'); isSidebarOpen.set(false); $event.preventDefault()" class="flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200" [class.bg-indigo-600]="activeTab() === 'payroll'" [class.text-white]="activeTab() === 'payroll'" [class.hover:bg-gray-100]="activeTab() !== 'payroll'" [class.dark:hover:bg-gray-700]="activeTab() !== 'payroll'">
           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" /></svg>
           <span class="ml-3 font-medium">Payroll</span>
        </a>
        <a href="#" (click)="setActiveTab('departments'); isSidebarOpen.set(false); $event.preventDefault()" class="flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200" [class.bg-indigo-600]="activeTab() === 'departments'" [class.text-white]="activeTab() === 'departments'" [class.hover:bg-gray-100]="activeTab() !== 'departments'" [class.dark:hover:bg-gray-700]="activeTab() !== 'departments'">
           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375M9 12h6.375M9 17.25h6.375" /></svg>
           <span class="ml-3 font-medium">Departments</span>
        </a>
        <a href="#" (click)="setActiveTab('analytics'); isSidebarOpen.set(false); $event.preventDefault()" class="flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200" [class.bg-indigo-600]="activeTab() === 'analytics'" [class.text-white]="activeTab() === 'analytics'" [class.hover:bg-gray-100]="activeTab() !== 'analytics'" [class.dark:hover:bg-gray-700]="activeTab() !== 'analytics'">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 9.75v3.75m0 0H15m-2.25 0H9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span class="ml-3 font-medium">Analytics</span>
        </a>
    </nav>
    
    <!-- Logout Footer -->
    <div class="px-4 py-4 mt-auto border-t border-gray-200 dark:border-gray-700">
      <button (click)="onLogout()" class="w-full flex items-center text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-red-500 hover:text-white dark:hover:bg-red-600 transition-colors duration-200">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
        <span class="ml-3 font-medium">Log Out</span>
      </button>
      @if(logoutError()){
        <p class="text-red-500 dark:text-red-400 text-xs mt-2 text-center">{{logoutError()}}</p>
      }
    </div>
  </div>

  <!-- Main Content -->
  <main class="flex-1 p-6 sm:p-8 lg:p-10 overflow-y-auto bg-gray-50 dark:bg-gray-900">
    <!-- Main Header -->
    <div class="flex items-center mb-4">
      <!-- Burger Button -->
      <button (click)="isSidebarOpen.set(true)" class="sm:hidden p-2 -ml-2 mr-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      </button>
      
      <!-- Header Content -->
      <div class="flex-1 flex justify-between items-center">
        @switch (activeTab()) {
            @case('employees') {
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Employee Management</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1 hidden sm:block">View, add, and manage all employees.</p>
                </div>
                <button (click)="openAddEmployeeModal()" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    <span class="hidden sm:inline">Add Employee</span>
                </button>
            }
            @case('dtr') {
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">DTR Logs</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1 hidden sm:block">Review all employee clock-in and clock-out events.</p>
                </div>
            }
            @case('payroll') {
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Payroll History</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1 hidden sm:block">View past payrolls or run a new one.</p>
                </div>
                <button (click)="isRunPayrollModalVisible.set(true)" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="hidden sm:inline">Run New Payroll</span>
                </button>
            }
            @case('departments') {
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Departments</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1 hidden sm:block">Manage company departments and roles.</p>
                </div>
                <button (click)="openAddDepartmentModal()" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    <span class="hidden sm:inline">Add Department</span>
                </button>
            }
            @case('analytics') {
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Attendance Analytics</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1 hidden sm:block">Monthly insights into employee attendance.</p>
                </div>
                <div class="flex-shrink-0">
                  <label for="analytics-month" class="sr-only">Select Month</label>
                  <select id="analytics-month"
                    class="block w-full sm:w-auto pl-3 pr-10 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 transition h-full"
                    [value]="analyticsMonth()"
                    (change)="setAnalyticsMonth($event)">
                    @for (month of monthsForSelector(); track month.value) {
                      <option [value]="month.value">{{ month.label }}</option>
                    }
                  </select>
                </div>
            }
        }
      </div>
    </div>

    @if (activeTab() === 'employees') {
      <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <!-- Search Input -->
        <div class="relative flex-grow">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
            </svg>
          </div>
          <input 
            type="search" 
            id="employee-search"
            placeholder="Search by name, email, or ID..." 
            class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 transition"
            [value]="searchTerm()"
            (input)="onSearchTermChange($event)">
        </div>
         <!-- Sort Dropdown -->
        <div class="flex-shrink-0">
          <label for="employee-sort" class="sr-only">Sort employees by</label>
          <select id="employee-sort"
            class="block w-full sm:w-auto pl-3 pr-10 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 transition h-full"
            (change)="setEmployeeSort($event)">
            <option value="newest">Sort by: Newest</option>
            <option value="oldest">Sort by: Oldest</option>
            <option value="lastNameAsc">Last Name (A-Z)</option>
            <option value="lastNameDesc">Last Name (Z-A)</option>
          </select>
        </div>
      </div>
    }

    <!-- Content Body -->
    @switch (activeTab()) {
      @case ('employees') {
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
          @if(employeesLoading()) { <p class="text-gray-700 dark:text-gray-300 text-center p-8">Loading employee data...</p> }
          @else if(employeesError()) { <p class="text-red-500 text-center p-8">{{ employeesError() }}</p> }
          @else {
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700/50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Employee ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Full Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Department</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Position</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Phone</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                  @for(employee of filteredEmployees(); track employee.id) {
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-600 dark:text-gray-400">{{ employee.employee_id }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ employee.first_name }} {{ employee.last_name }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ employee.departments?.name || employee.position }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ employee.departments?.name ? employee.position : '' }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ employee.email }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ employee.mobile_number }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center gap-1">
                          <button (click)="openIdCardModal(employee)" class="p-2 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" title="Show ID Card">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2h-8zM2 4a2 2 0 012-2h2v16H4a2 2 0 01-2-2V4zm10 2a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1zm-5 0a1 1 0 011-1h2a1 1 0 110 2H8a1 1 0 01-1-1zm-1 4a1 1 0 100 2h6a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                          </button>
                          <button (click)="openViewEmployeeModal(employee)" class="p-2 rounded-full text-gray-400 hover:bg-blue-100 dark:hover:bg-blue-900/50 hover:text-blue-600 dark:hover:text-blue-300 transition-colors" title="View Details">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                          </button>
                          <button (click)="openEditEmployeeModal(employee)" class="p-2 rounded-full text-gray-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 hover:text-indigo-600 dark:hover:text-indigo-300 transition-colors" title="Edit Employee">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                          </button>
                          <button (click)="openDeleteEmployeeConfirmation(employee)" class="p-2 rounded-full text-gray-400 hover:bg-red-100 dark:hover:bg-red-900/50 hover:text-red-600 dark:hover:text-red-300 transition-colors" title="Deactivate Employee">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  } @empty {
                    @if (searchTerm()) {
                      <tr><td colspan="7" class="text-center py-8 text-gray-500 dark:text-gray-400">No employees match your search for "{{ searchTerm() }}".</td></tr>
                    } @else {
                      <tr><td colspan="7" class="text-center py-8 text-gray-500 dark:text-gray-400">No employees found. Add one to get started.</td></tr>
                    }
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      }
      @case ('dtr') {
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
          <!-- DTR Search -->
          <div class="relative flex-grow">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                  </svg>
              </div>
              <input 
                  type="search" 
                  placeholder="Search by employee name..." 
                  class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 transition"
                  [value]="dtrSearchTerm()"
                  (input)="onDtrSearchTermChange($event)">
          </div>
          <!-- DTR Sort -->
          <div class="flex-shrink-0">
            <label for="dtr-sort" class="sr-only">Sort DTR logs by</label>
            <select id="dtr-sort"
                class="block w-full sm:w-auto pl-3 pr-10 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 transition h-full"
                (change)="setDtrSort($event)">
                <option value="newest">Sort by: Newest</option>
                <option value="oldest">Sort by: Oldest</option>
                <option value="nameAsc">Employee Name (A-Z)</option>
                <option value="nameDesc">Employee Name (Z-A)</option>
            </select>
          </div>
        </div>
        
        @if(dtrLoading()){
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center text-gray-500 dark:text-gray-400">Loading DTR entries...</div>
        } @else if(dtrError()){
          <div class="bg-red-100 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-300 p-4 rounded-md" role="alert">
            <p class="font-bold">Error loading DTR logs:</p>
            <p>{{dtrError()}}</p>
          </div>
        } @else if (groupedDtrEntries().length > 0) {
          <div class="space-y-4">
            @for(group of groupedDtrEntries(); track group.monthYearValue) {
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                <button (click)="toggleDtrMonth(group.monthYearValue)" class="w-full flex justify-between items-center p-4 text-left bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                  <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">{{ group.monthYearDisplay }} Logs</h3>
                  <svg class="w-6 h-6 text-gray-500 dark:text-gray-400 transition-transform duration-300" [class.rotate-180]="openDtrMonths().has(group.monthYearValue)" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                  </svg>
                </button>
                
                @if(openDtrMonths().has(group.monthYearValue)) {
                  <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    @if (group.entries.length > 0) {
                      <div class="overflow-x-auto">
                        <table class="min-w-full">
                          <thead class="bg-gray-50 dark:bg-gray-700/50">
                            <tr>
                              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Employee</th>
                              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Time In</th>
                              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Time Out</th>
                            </tr>
                          </thead>
                          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                             @for(entry of group.entries; track entry.id) {
                              <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{entry.profiles?.first_name}} {{entry.profiles?.last_name}}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{entry.time_in | date:'short'}}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{entry.time_out ? (entry.time_out | date:'short') : 'Not clocked out'}}</td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    } @else {
                      <p class="text-center py-4 text-gray-500 dark:text-gray-400">No entries match your search for this month.</p>
                    }
                  </div>
                }
              </div>
            }
          </div>
        } @else {
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center text-gray-500 dark:text-gray-400">
            No DTR entries have been recorded yet.
          </div>
        }
      }
      @case ('payroll') {
         <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
          @if(payrollsLoading()){ <p class="text-gray-700 dark:text-gray-300 text-center p-8">Loading payrolls...</p> }
          @else if(payrollsError()){ <p class="text-red-500 text-center p-8">{{payrollsError()}}</p> }
          @else {
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700/50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Employee</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pay Period</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Net Pay</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                  @for(payroll of payrolls(); track payroll.id) {
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{payroll.profiles?.first_name}} {{payroll.profiles?.last_name}}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{payroll.pay_period_start | date:'shortDate'}} - {{payroll.pay_period_end | date:'shortDate'}}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{payroll.net_pay | currency:'PHP':'symbol':'1.2-2'}}</td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full"
                          [class.bg-yellow-100]="payroll.status === 'Delayed'" [class.text-yellow-800]="payroll.status === 'Delayed'"
                          [class.dark:bg-yellow-900/50]="payroll.status === 'Delayed'" [class.dark:text-yellow-300]="payroll.status === 'Delayed'"
                          [class.bg-red-100]="payroll.status === 'Unpaid'" [class.text-red-800]="payroll.status === 'Unpaid'"
                          [class.dark:bg-red-900/50]="payroll.status === 'Unpaid'" [class.dark:text-red-300]="payroll.status === 'Unpaid'"
                          [class.bg-green-100]="payroll.status === 'Paid'" [class.text-green-800]="payroll.status === 'Paid'"
                          [class.dark:bg-green-900/50]="payroll.status === 'Paid'" [class.dark:text-green-300]="payroll.status === 'Paid'">
                          {{ payroll.status }}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <select [value]="payroll.status" (change)="onPayrollStatusChange(payroll.id, $event)" class="block w-full pl-3 pr-8 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                          <option value="Paid">Paid</option>
                          <option value="Delayed">Delayed</option>
                          <option value="Unpaid">Unpaid</option>
                        </select>
                      </td>
                    </tr>
                  } @empty {
                    <tr><td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">No payrolls found.</td></tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      }
      @case ('departments') {
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
          @if(departmentsLoading()){ <p class="text-gray-700 dark:text-gray-300 text-center p-8">Loading departments...</p> }
          @else if(departmentsError()){ <p class="text-red-500 text-center p-8">{{departmentsError()}}</p> }
          @else {
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700/50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Work Hours</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Lateness Rules</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Deduction Rate</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                   @for(dept of departments(); track dept.id) {
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{dept.name}}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{dept.work_start_time}} - {{dept.work_end_time}}</td>
                       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        Grace Period: {{dept.grace_period_minutes}} min
                       </td>
                       <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-600 dark:text-gray-300">
                        {{dept.deduction_rate_per_minute | currency:'PHP'}} / min
                       </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                        <button (click)="openEditDepartmentModal(dept)" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-200">Edit</button>
                        <button (click)="openDeleteDepartmentConfirmation(dept)" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200">Delete</button>
                      </td>
                    </tr>
                  } @empty {
                     <tr><td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">No departments found.</td></tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      }
      @case('analytics') {
        <div class="space-y-8">
          <!-- Stat Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4">
              <div class="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-full"><svg class="w-6 h-6 text-blue-600 dark:text-blue-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" /></svg></div>
              <div><p class="text-sm text-gray-500 dark:text-gray-400">Total Employees</p><p class="text-2xl font-bold text-gray-900 dark:text-white">{{ totalEmployees() }}</p></div>
            </div>
             <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4">
              <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-full"><svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg></div>
              <div><p class="text-sm text-gray-500 dark:text-gray-400">Absent Employees</p><p class="text-2xl font-bold text-gray-900 dark:text-white">{{ analyticsReport().absentCount }}</p></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4">
              <div class="bg-yellow-100 dark:bg-yellow-900/50 p-3 rounded-full"><svg class="w-6 h-6 text-yellow-600 dark:text-yellow-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
              <div><p class="text-sm text-gray-500 dark:text-gray-400">Late Arrivals</p><p class="text-2xl font-bold text-gray-900 dark:text-white">{{ analyticsReport().lateCount }}</p></div>
            </div>
             <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4">
              <div class="bg-orange-100 dark:bg-orange-900/50 p-3 rounded-full"><svg class="w-6 h-6 text-orange-600 dark:text-orange-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75v3.75m-3.75 0H15M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
              <div><p class="text-sm text-gray-500 dark:text-gray-400">Early Departures</p><p class="text-2xl font-bold text-gray-900 dark:text-white">{{ analyticsReport().earlyCount }}</p></div>
            </div>
          </div>
          <!-- Lateness Chart -->
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-6">Daily Late Arrivals this Month</h3>
            @if (analyticsLoading()) {
              <div class="flex items-center justify-center h-64"><p class="text-gray-500 dark:text-gray-400">Loading chart data...</p></div>
            } @else if(analyticsError()) {
              <div class="flex items-center justify-center h-64"><p class="text-red-500 dark:text-red-400">{{ analyticsError() }}</p></div>
            } @else if (analyticsReport().lateByDay.length > 0) {
              <div class="w-full h-72 flex items-end gap-2 border-b-2 border-l-2 border-gray-200 dark:border-gray-700 p-4">
                @for (item of analyticsReport().lateByDay; track item.day) {
                  <div class="flex-1 h-full flex flex-col justify-end items-center relative bar-container">
                    <div class="chart-bar w-3/4 bg-indigo-500 hover:bg-indigo-600 rounded-t-md" [style.height.%]="(item.count / analyticsReport().maxLateCount) * 100"></div>
                    <span class="text-xs mt-1 text-gray-500 dark:text-gray-400">{{ item.day }}</span>
                    <div class="bar-tooltip absolute bottom-full mb-2 w-max px-2 py-1 bg-gray-900 text-white text-xs rounded-md shadow-lg">
                      {{ item.count }} late
                    </div>
                  </div>
                }
              </div>
            } @else {
               <div class="flex items-center justify-center h-64"><p class="text-gray-500 dark:text-gray-400">No late arrival data for this month.</p></div>
            }
          </div>
        </div>
      }
    }
  </main>
</div>

<app-add-employee-modal 
  [visible]="isAddEmployeeModalVisible()"
  [departments]="departments()"
  [currentUserRole]="currentUserRole()"
  [employeeToEdit]="employeeToEdit()"
  (close)="closeEmployeeModal()"
  (employeeSaved)="refreshAllData()"
></app-add-employee-modal>

<app-add-department-modal
  [visible]="isAddDepartmentModalVisible()"
  [departmentToEdit]="departmentToEdit()"
  (close)="closeDepartmentModal()"
  (departmentSaved)="loadDepartments()"
></app-add-department-modal>

<app-run-payroll-modal
  [visible]="isRunPayrollModalVisible()"
  [departments]="departments()"
  (close)="isRunPayrollModalVisible.set(false)"
  (payrollRun)="refreshPayrolls()"
></app-run-payroll-modal>

<app-confirmation-modal
  [visible]="isConfirmModalVisible()"
  [title]="confirmModalConfig().title"
  [message]="confirmModalConfig().message"
  (close)="isConfirmModalVisible.set(false)"
  (confirm)="confirmModalConfig().onConfirm()"
></app-confirmation-modal>

<app-view-employee-modal
  [visible]="isViewEmployeeModalVisible()"
  [employee]="selectedEmployee()"
  (close)="isViewEmployeeModalVisible.set(false)"
></app-view-employee-modal>

<app-id-card-modal
  [visible]="isIdCardModalVisible()"
  [employee]="selectedEmployee()"
  (close)="isIdCardModalVisible.set(false)"
></app-id-card-modal>