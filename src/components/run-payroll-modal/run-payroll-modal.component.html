<!--
  Note on CSV Colors: The user requested colored headers for CSV export.
  CSV (Comma-Separated Values) is a plain text format and does not support styling like colors or bold text.
  The generated CSV will have clear, standard headers that can be easily read by any spreadsheet software like Excel or Google Sheets,
  which may then apply its own styling. This note is for clarification as the direct feature request is not technically feasible.
-->
@if (visible()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" (click)="closeModal()">
    <div class="relative w-full max-w-7xl bg-slate-900/80 backdrop-blur-md border border-blue-800/50 shadow-2xl shadow-black/50 rounded-2xl m-4 max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
      
      <div class="p-6 border-b border-blue-800/50 flex justify-between items-center">
        <h2 class="text-2xl font-bold text-white">Run New Payroll</h2>
        <button (click)="closeModal()" class="p-2 text-gray-400 rounded-full hover:bg-white/10">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
        </button>
      </div>

      <div class="p-4 md:p-8 overflow-y-auto">
        @switch (modalState()) {
          @case ('preview') {
            <div>
              <h3 class="text-lg font-semibold text-gray-200 mb-4">Payroll Preview: {{ payPeriod()?.start | date:'mediumDate' }} to {{ payPeriod()?.end | date:'mediumDate' }}</h3>
              @if (errorMessage()) {
                <div class="bg-red-500/20 border-l-4 border-red-500 text-red-300 p-4 mb-4" role="alert">
                  <p>{{ errorMessage() }}</p>
                </div>
              }
              <div class="overflow-x-auto border border-blue-800/50 rounded-lg">
                <table class="min-w-full divide-y divide-blue-800/50 md:table">
                  <thead class="bg-slate-800/50 hidden md:table-header-group">
                    <tr>
                      <th class="px-4 py-3 text-left">
                        <input type="checkbox" class="h-4 w-4 rounded border-gray-600 text-violet-600 focus:ring-violet-500 bg-gray-900 ring-offset-gray-800" [checked]="isAllSelected()" (change)="toggleSelectAll()">
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Employee</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Base Pay</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Bonuses & Raises</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Total Gross</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Deductions</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Manual Deduction</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Net Pay</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-blue-800/50">
                    @for (item of payrollPreviews(); track item.employeeId) {
                      <tr class="block md:table-row hover:bg-white/5">
                        <td class="px-4 py-3 md:table-cell block">
                           <input type="checkbox" class="h-4 w-4 rounded border-gray-600 text-violet-600 focus:ring-violet-500 bg-gray-900 ring-offset-gray-800" [checked]="item.selected" (change)="toggleEmployeeSelection(item.employeeId)">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-white md:table-cell block">
                           <span class="font-bold text-gray-400 md:hidden">Employee: </span>
                           {{ item.employeeName }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-400 md:table-cell block">
                           <span class="font-bold text-gray-400 md:hidden">Base Pay: </span>
                           {{ item.baseGrossPay | currency:'PHP' }}
                        </td>
                         <td class="px-4 py-3 whitespace-nowrap text-sm text-green-400 md:table-cell block">
                            <span class="font-bold text-gray-400 md:hidden">Bonuses: </span>
                            {{ (item.birthMonthBonus + item.salaryRaise) | currency:'PHP' }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-300 md:table-cell block">
                           <span class="font-bold text-gray-400 md:hidden">Gross Pay: </span>
                           {{ item.totalGrossPay | currency:'PHP' }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-orange-400 md:table-cell block">
                          <span class="font-bold text-gray-400 md:hidden">Auto Deductions: </span>
                          {{ (item.latenessDeductions + item.underTimeDeductions) | currency:'PHP' }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm md:table-cell block">
                           <span class="font-bold text-gray-400 md:hidden">Manual Deduction: </span>
                          <input type="number" class="w-24 px-2 py-1 rounded-md bg-slate-800/50 border-2 border-blue-800/60 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/30 text-gray-200" [value]="item.manualDeductions" (input)="updateManualDeduction(item.employeeId, $event)" min="0" step="0.01">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-white md:table-cell block">
                           <span class="font-bold text-gray-400 md:hidden">Net Pay: </span>
                           {{ item.netPay | currency:'PHP' }}
                        </td>
                      </tr>
                    }
                  </tbody>
                  <tfoot class="bg-slate-800/50">
                    <tr class="block md:table-row">
                      <td colspan="7" class="px-4 py-3 text-left md:text-right text-sm font-bold text-gray-200 block md:table-cell">Total Payroll Cost ({{ selectedEmployeesCount() }} employees):</td>
                      <td class="px-4 py-3 text-left text-sm font-bold text-white block md:table-cell">{{ totalPayrollCost() | currency:'PHP' }}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          }
          @case ('loading') {
            <div class="flex flex-col items-center justify-center p-16 space-y-4">
              <svg class="animate-spin h-12 w-12 text-violet-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
              <p class="text-xl font-semibold text-gray-300">Generating Payroll Preview...</p>
            </div>
          }
          @case ('success') {
            <div class="text-center p-16 space-y-4">
              <h2 class="text-2xl font-bold text-green-400">Payroll Run Successfully!</h2>
              <p class="text-gray-400">The payroll has been processed and recorded.</p>
            </div>
          }
          @case ('error') {
             <div class="text-center p-16 space-y-4">
              <h2 class="text-2xl font-bold text-red-400">Error Generating Payroll</h2>
              <p class="text-gray-400">{{ errorMessage() }}</p>
            </div>
          }
        }
      </div>

      <div class="p-6 border-t border-blue-800/50 bg-slate-900/50 flex justify-end gap-4 mt-auto">
        @if (modalState() === 'preview') {
          <button (click)="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-200 bg-slate-700 border border-blue-800/50 rounded-lg hover:bg-slate-600 transition-colors">Cancel</button>
          <button (click)="onConfirmRunPayroll()" [disabled]="selectedEmployeesCount() === 0" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg shadow-sm hover:bg-green-700 disabled:bg-green-400/50 disabled:cursor-not-allowed">Confirm & Run Payroll</button>
        }
        @if (modalState() === 'success') {
          <button (click)="finishAndClose()" class="px-4 py-2 text-sm font-medium text-white bg-violet-600 rounded-lg shadow-sm hover:bg-violet-700">Done</button>
        }
        @if (modalState() === 'loading') {
          <button disabled class="px-4 py-2 text-sm font-medium text-white bg-violet-500/50 rounded-lg cursor-not-allowed">Loading...</button>
        }
         @if (modalState() === 'error') {
          <button (click)="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-200 bg-slate-700 border border-blue-800/50 rounded-lg hover:bg-slate-600 transition-colors">Close</button>
        }
      </div>
    </div>
  </div>
}